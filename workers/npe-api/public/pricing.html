<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Humanizer - Upgrade Membership</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 40px 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 2.5rem; }
    .subtitle { text-align: center; color: #a0a0a0; margin-bottom: 40px; }

    /* Auth Section */
    .auth-section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .auth-section h3 { margin-bottom: 15px; }
    .auth-section input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #1a1a2e;
      color: #fff;
    }
    .auth-section button {
      width: 100%;
      padding: 12px;
      background: #6c5ce7;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    .auth-section button:hover { background: #5b4cdb; }
    .user-info { color: #00ff88; margin-top: 10px; }
    .error { color: #ff6b6b; margin-top: 10px; }

    /* Pricing Grid */
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    .pricing-card {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 30px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.2s, border-color 0.2s;
    }
    .pricing-card:hover {
      transform: translateY(-4px);
      border-color: #6c5ce7;
    }
    .pricing-card.popular {
      border-color: #6c5ce7;
      position: relative;
    }
    .popular-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: #6c5ce7;
      padding: 4px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .tier-name { font-size: 1.5rem; font-weight: 600; margin-bottom: 8px; }
    .price { font-size: 2.5rem; font-weight: 700; margin-bottom: 5px; }
    .price span { font-size: 1rem; color: #a0a0a0; }
    .tax-note { font-size: 0.8rem; color: #666; margin-bottom: 20px; }
    .features { list-style: none; margin-bottom: 24px; }
    .features li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .features li::before { content: '✓'; color: #00ff88; }
    .upgrade-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upgrade-btn.primary {
      background: #6c5ce7;
      color: #fff;
    }
    .upgrade-btn.primary:hover { background: #5b4cdb; }
    .upgrade-btn.secondary {
      background: transparent;
      border: 2px solid #6c5ce7;
      color: #6c5ce7;
    }
    .upgrade-btn.secondary:hover {
      background: #6c5ce7;
      color: #fff;
    }
    .upgrade-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Day Pass */
    .day-pass {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 30px;
    }
    .day-pass h3 { margin-bottom: 8px; }
    .day-pass p { color: #a0a0a0; margin-bottom: 15px; }
    .day-pass button {
      padding: 10px 24px;
      background: #00b894;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    .day-pass button:hover { background: #00a381; }

    /* Promo */
    .promo-section {
      max-width: 400px;
      margin: 0 auto 30px;
      text-align: center;
    }
    .promo-input {
      display: flex;
      gap: 10px;
    }
    .promo-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 6px;
      background: #1a1a2e;
      color: #fff;
    }
    .promo-input button {
      padding: 12px 20px;
      background: #333;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
    }
    .promo-result { margin-top: 10px; font-size: 0.9rem; }
    .promo-valid { color: #00ff88; }
    .promo-invalid { color: #ff6b6b; }

    /* Options */
    .options {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .option-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .option-label input { cursor: pointer; }

    /* Loading */
    .loading { opacity: 0.7; pointer-events: none; }

    /* Footer */
    footer {
      text-align: center;
      color: #666;
      margin-top: 40px;
      font-size: 0.9rem;
    }
    footer a { color: #6c5ce7; text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Upgrade Your Membership</h1>
    <p class="subtitle">Choose the plan that's right for you</p>

    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
      <h3>Sign In to Continue</h3>
      <input type="email" id="email" placeholder="Email" value="">
      <input type="password" id="password" placeholder="Password" value="">
      <button onclick="login()">Sign In</button>
      <div id="authStatus"></div>
    </div>

    <!-- Options -->
    <div class="options" id="optionsSection" style="display:none;">
      <label class="option-label">
        <input type="checkbox" id="withTrial" checked>
        Include 7-day free trial
      </label>
    </div>

    <!-- Promo Code -->
    <div class="promo-section" id="promoSection" style="display:none;">
      <div class="promo-input">
        <input type="text" id="promoCode" placeholder="Promo code (e.g., human50)">
        <button onclick="validatePromo()">Apply</button>
      </div>
      <div id="promoResult" class="promo-result"></div>
    </div>

    <!-- Pricing Grid -->
    <div class="pricing-grid" id="pricingGrid" style="display:none;">
      <!-- Member -->
      <div class="pricing-card">
        <div class="tier-name">Standard</div>
        <div class="price">$9.99 <span>/month</span></div>
        <div class="tax-note">Tax included (8.625% NY)</div>
        <ul class="features">
          <li>50 transformations/month</li>
          <li>100K tokens/month</li>
          <li>Basic AI detection</li>
          <li>Standard support</li>
        </ul>
        <button class="upgrade-btn secondary" onclick="checkout('member')">
          Get Started
        </button>
      </div>

      <!-- Pro -->
      <div class="pricing-card popular">
        <div class="popular-badge">MOST POPULAR</div>
        <div class="tier-name">Professional</div>
        <div class="price">$29.99 <span>/month</span></div>
        <div class="tax-note">Tax included (8.625% NY)</div>
        <ul class="features">
          <li>200 transformations/month</li>
          <li>1.6M tokens/month</li>
          <li>Advanced AI detection (GPTZero)</li>
          <li>Personalizer (personas & styles)</li>
          <li>Priority support</li>
        </ul>
        <button class="upgrade-btn primary" onclick="checkout('pro')">
          Upgrade to Pro
        </button>
      </div>

      <!-- Premium -->
      <div class="pricing-card">
        <div class="tier-name">Premium</div>
        <div class="price">$99.99 <span>/month</span></div>
        <div class="tax-note">Tax included (8.625% NY)</div>
        <ul class="features">
          <li>Unlimited transformations</li>
          <li>Unlimited tokens</li>
          <li>Full AI detection suite</li>
          <li>Custom personas & styles</li>
          <li>API access</li>
          <li>Dedicated support</li>
        </ul>
        <button class="upgrade-btn secondary" onclick="checkout('premium')">
          Go Premium
        </button>
      </div>
    </div>

    <!-- Day Pass -->
    <div class="day-pass" id="dayPassSection" style="display:none;">
      <h3>Just need a quick fix? Try a Day Pass</h3>
      <p>$2.99 for 24 hours of full Pro access. No commitment.</p>
      <button onclick="buyDayPass()">Buy Day Pass</button>
    </div>

    <footer>
      <p>Powered by <a href="https://stripe.com" target="_blank">Stripe</a> • Test mode</p>
      <p style="margin-top:8px;">Test card: 4242 4242 4242 4242</p>
    </footer>
  </div>

  <script>
    const API_BASE = 'https://npe-api.tem-527.workers.dev';
    let token = localStorage.getItem('humanizer_token');
    let validPromoCode = null;

    // Check if already logged in
    if (token) {
      checkAuth();
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const status = document.getElementById('authStatus');

      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (data.token) {
          token = data.token;
          localStorage.setItem('humanizer_token', token);
          status.className = 'user-info';
          status.textContent = `✓ Signed in as ${data.user.email} (${data.user.role} tier)`;
          showPricing();
        } else {
          status.className = 'error';
          status.textContent = data.error || 'Login failed';
        }
      } catch (err) {
        status.className = 'error';
        status.textContent = 'Connection error';
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch(`${API_BASE}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
          const user = await res.json();
          document.getElementById('authStatus').className = 'user-info';
          document.getElementById('authStatus').textContent = `✓ Signed in as ${user.email} (${user.role} tier)`;
          showPricing();
        } else {
          localStorage.removeItem('humanizer_token');
          token = null;
        }
      } catch (err) {
        localStorage.removeItem('humanizer_token');
        token = null;
      }
    }

    function showPricing() {
      document.getElementById('optionsSection').style.display = 'flex';
      document.getElementById('promoSection').style.display = 'block';
      document.getElementById('pricingGrid').style.display = 'grid';
      document.getElementById('dayPassSection').style.display = 'block';
    }

    async function validatePromo() {
      const code = document.getElementById('promoCode').value.trim();
      const result = document.getElementById('promoResult');

      if (!code) {
        result.className = 'promo-result promo-invalid';
        result.textContent = 'Enter a promo code';
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/stripe/validate-promo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        const data = await res.json();

        if (data.valid) {
          validPromoCode = code;
          result.className = 'promo-result promo-valid';
          const discount = data.discount.type === 'percent'
            ? `${data.discount.value}% off`
            : `$${data.discount.value} off`;
          result.textContent = `✓ ${discount} applied!`;
        } else {
          validPromoCode = null;
          result.className = 'promo-result promo-invalid';
          result.textContent = data.error || 'Invalid code';
        }
      } catch (err) {
        result.className = 'promo-result promo-invalid';
        result.textContent = 'Failed to validate';
      }
    }

    async function checkout(tier) {
      if (!token) {
        alert('Please sign in first');
        return;
      }

      const withTrial = document.getElementById('withTrial').checked;
      const body = { tier, withTrial };

      if (validPromoCode) {
        body.promoCode = validPromoCode;
      }

      try {
        const res = await fetch(`${API_BASE}/stripe/checkout`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || 'Failed to create checkout');
        }
      } catch (err) {
        alert('Connection error');
      }
    }

    async function buyDayPass() {
      if (!token) {
        alert('Please sign in first');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/stripe/day-pass`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({})
        });

        const data = await res.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || 'Failed to create checkout');
        }
      } catch (err) {
        alert('Connection error');
      }
    }
  </script>
</body>
</html>
